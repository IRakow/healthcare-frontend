import{r,j as e,C as N,B as d,q as P,t as E,S as _,v as z,s as o,e as C,g as V,U,d as A,F}from"./index-rNJXb22Z.js";function I({appointmentId:a,patientId:f,onSave:g}){const[m,x]=r.useState(!1),[s,j]=r.useState(""),[p,v]=r.useState(!1),[w,t]=r.useState(!1),c=r.useRef(null),S=r.useRef([]);r.useEffect(()=>{if(!("webkitSpeechRecognition"in window))return;const i=window.webkitSpeechRecognition,n=new i;return n.continuous=!0,n.interimResults=!0,n.lang="en-US",n.onresult=l=>{let u="",b="";for(let h=l.resultIndex;h<l.results.length;h++){const y=l.results[h];y.isFinal?u+=y[0].transcript+" ":b+=y[0].transcript}u&&j(h=>h+u)},m?n.start():n.stop(),()=>{n.stop()}},[m]);const R=async()=>{try{const i=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(i);n.ondataavailable=l=>{l.data.size>0&&S.current.push(l.data)},n.start(1e3),c.current=n,x(!0)}catch(i){console.error("Error starting recording:",i),alert("Failed to start recording. Please check microphone permissions.")}},T=()=>{c.current&&c.current.state!=="inactive"&&(c.current.stop(),c.current.stream.getTracks().forEach(i=>i.stop()),x(!1))},k=async()=>{if(!s.trim()){alert("No transcript to save");return}v(!0),t(!0);try{const{data:{session:i}}=await o.auth.getSession();if(!i)throw new Error("No session");const l=await fetch("/functions/v1/ai-summarize-transcript",{method:"POST",body:JSON.stringify({transcript:s,appointmentId:a}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`}});let u="Summary not available";l.ok&&(u=(await l.json()).summary||"Summary not available"),await o.from("patient_timeline_events").insert({patient_id:f,type:"ai",label:"Visit Transcript",data:{appointment_id:a,summary:u,rawTranscript:s,duration:Math.floor(s.split(" ").length/150),timestamp:new Date().toISOString()}}),alert("Transcript saved successfully!"),g&&g(),j(""),S.current=[]}catch(i){console.error("Error saving transcript:",i),alert("Failed to save transcript. Please try again.")}finally{v(!1),t(!1)}};return e.jsx(N,{children:e.jsxs("div",{className:"p-4",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Visit Transcript"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-2",children:[m?e.jsxs(d,{onClick:T,variant:"outline",size:"sm",className:"text-red-600",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Stop Recording"]}):e.jsxs(d,{onClick:R,variant:"outline",size:"sm",children:[e.jsx(P,{className:"h-4 w-4 mr-2"}),"Start Recording"]}),e.jsx(d,{onClick:k,disabled:!s.trim()||p,size:"sm",children:p?e.jsxs(e.Fragment,{children:[e.jsx(_,{size:"sm",className:"mr-2"}),w?"Processing...":"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Save Transcript"]})})]}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-3 min-h-[100px] max-h-[200px] overflow-y-auto",children:s?e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s}):e.jsx("p",{className:"text-sm text-gray-500 italic",children:m?"Listening...":'Click "Start Recording" to begin transcription'})}),s&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Word count: ",s.split(" ").filter(i=>i.trim()).length]})]})]})})}function M(){const{appointmentId:a}=C(),[f,g]=r.useState(""),[m,x]=r.useState(!0),[s,j]=r.useState(null),[p,v]=r.useState(null);r.useEffect(()=>{a&&(async()=>{try{const{data:t}=await o.from("appointments").select(`
            *,
            patient:users!appointments_patient_id_fkey(
              id,
              full_name,
              email
            )
          `).eq("id",a).maybeSingle();if(!t){console.error("Appointment not found"),x(!1);return}j(t),v(t.patient);let c=t.video_url;c||(c=V(a),await o.from("appointments").update({video_url:c}).eq("id",a)),t.status==="pending"&&await o.from("appointments").update({status:"in_progress"}).eq("id",a),t.status==="pending"&&await o.from("patient_timeline_events").insert({patient_id:t.patient_id,type:"visit",label:"Video Visit Started",data:{appointment_id:t.id}}),g(c)}catch(t){console.error("Error setting up video session:",t)}finally{x(!1)}})()},[a]);async function w(){if(!(!a||!s))try{await o.from("appointments").update({status:"complete"}).eq("id",a),await o.from("patient_timeline_events").insert({patient_id:s.patient_id,type:"visit",label:"Video Visit Completed",data:{appointment_id:a}}),window.location.href="/provider"}catch(t){console.error("Error ending appointment:",t),alert("Failed to end appointment")}}return m?e.jsx("div",{className:"flex items-center justify-center h-[80vh]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(_,{size:"lg"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Setting up your video session..."})]})}):f?e.jsxs("div",{className:"p-6 max-w-screen-2xl mx-auto",children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Telemedicine Visit"}),e.jsx(d,{variant:"outline",onClick:w,children:"End Appointment"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[e.jsx("div",{className:"lg:col-span-3",children:e.jsx("iframe",{title:"Telemedicine Session",src:f,className:"w-full h-[80vh] rounded-xl border shadow-xl",allow:"camera; microphone; fullscreen; display-capture"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(N,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4"}),"Patient Information"]}),p&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",p.full_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",p.email]})]})]})}),e.jsx(N,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(A,{className:"h-4 w-4"}),"Appointment Details"]}),s&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",new Date(s.date).toLocaleDateString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Time:"})," ",s.time]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Type:"})," Telemedicine"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Reason:"})," ",s.reason]})]})]})}),e.jsx(N,{children:e.jsxs("div",{className:"p-4",children:[e.jsxs("h3",{className:"font-semibold mb-3 flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4"}),"Quick Actions"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{size:"sm",variant:"outline",className:"w-full",children:"View Patient History"}),e.jsx(d,{size:"sm",variant:"outline",className:"w-full",children:"Add Visit Notes"}),e.jsx(d,{size:"sm",variant:"outline",className:"w-full",children:"Prescribe Medication"})]})]})}),s&&e.jsx(I,{appointmentId:a,patientId:s.patient_id,onSave:()=>{console.log("Transcript saved")}})]})]})]}):e.jsx("div",{className:"flex items-center justify-center h-[80vh]",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-red-600",children:"Unable to start video session"}),e.jsx("p",{className:"text-sm text-gray-600 mt-2",children:"Please check the appointment details"})]})})}export{M as default};
