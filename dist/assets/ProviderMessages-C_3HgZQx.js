import{w as M,r as i,s as n,j as e,C as f,U as _,m as L,d as P,I as B,B as I}from"./index-fVnNLllJ.js";const b=M("MessageCircle",[["path",{d:"m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z",key:"v2veuj"}]]),R=M("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);function z(){var y;const[d,u]=i.useState([]),[t,S]=i.useState(null),[o,g]=i.useState([]),[m,h]=i.useState(""),[q,C]=i.useState(!0),[j,p]=i.useState(!1),v=i.useRef(null);i.useEffect(()=>{T()},[]),i.useEffect(()=>{t&&k(t.id)},[t]),i.useEffect(()=>{E(),D()},[o]);const E=()=>{var s;(s=v.current)==null||s.scrollIntoView({behavior:"smooth"})};async function T(){try{const{data:{user:s}}=await n.auth.getUser();if(!s)return;const{data:a}=await n.from("message_threads").select("*").eq("provider_id",s.id);if(a){const r=await Promise.all(a.map(async c=>{const{data:l}=await n.from("messages").select("*").eq("thread_id",c.id).order("created_at",{ascending:!1}).limit(1).single(),{count:x}=await n.from("messages").select("*",{count:"exact",head:!0}).eq("thread_id",c.id).eq("recipient_id",s.id).eq("seen",!1);return{...c,last_message:l,unread_count:x||0}}));u(r)}}catch(s){console.error("Error loading threads:",s)}finally{C(!1)}}async function k(s){const{data:a}=await n.from("messages").select("*").eq("thread_id",s).order("created_at");g(a||[])}async function D(){if(!t||o.length===0)return;const{data:{user:s}}=await n.auth.getUser();s&&(await n.from("messages").update({seen:!0}).eq("thread_id",t.id).eq("recipient_id",s.id).eq("seen",!1),u(d.map(a=>a.id===t.id?{...a,unread_count:0}:a)))}async function N(){if(!(!m.trim()||!t)){p(!0);try{const{data:{user:s}}=await n.auth.getUser();if(!s)return;const a={sender_id:s.id,recipient_id:t.patient_id,thread_id:t.id,message:m.trim()},{data:r,error:c}=await n.from("messages").insert(a).select().single();!c&&r&&(g([...o,r]),h(""),u(d.map(l=>l.id===t.id?{...l,last_message:r}:l)))}catch(s){console.error("Error sending message:",s)}finally{p(!1)}}}const $=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),N())},U=s=>{const a=new Date(s),c=new Date().getTime()-a.getTime(),l=Math.floor(c/6e4),x=Math.floor(c/36e5),w=Math.floor(c/864e5);return l<1?"Just now":l<60?`${l}m ago`:x<24?`${x}h ago`:w<7?`${w}d ago`:a.toLocaleDateString()};return q?e.jsx("div",{className:"p-6 max-w-screen-xl mx-auto",children:e.jsx("div",{className:"text-center",children:"Loading messages..."})}):e.jsxs("div",{className:"p-6 max-w-screen-xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-6",children:[e.jsx(b,{className:"h-6 w-6 text-blue-600"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Messages"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"md:col-span-1",children:e.jsxs(f,{children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"font-semibold",children:"Conversations"})}),e.jsx("div",{className:"divide-y max-h-[600px] overflow-y-auto",children:d.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:"No conversations yet"}):d.map(s=>{var a;return e.jsx("div",{onClick:()=>S(s),className:`p-4 hover:bg-gray-50 cursor-pointer transition-colors ${(t==null?void 0:t.id)===s.id?"bg-blue-50":""}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx(_,{className:"h-5 w-5 text-gray-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-medium",children:(a=s.patient)==null?void 0:a.full_name}),s.unread_count>0&&e.jsx(L,{variant:"destructive",className:"text-xs",children:s.unread_count})]}),s.last_message&&e.jsx("p",{className:"text-sm text-gray-600 truncate",children:s.last_message.message})]})]}),s.last_message&&e.jsx("span",{className:"text-xs text-gray-500",children:U(s.last_message.created_at)})]})},s.id)})})]})}),e.jsx("div",{className:"md:col-span-2",children:t?e.jsxs(f,{className:"h-[600px] flex flex-col",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx(_,{className:"h-5 w-5 text-gray-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:(y=t.patient)==null?void 0:y.full_name}),e.jsx("p",{className:"text-sm text-gray-600",children:"Patient"})]})]})}),e.jsx("div",{className:"flex-1 p-4 overflow-y-auto",children:e.jsxs("div",{className:"space-y-3",children:[o.map(s=>{const{data:{user:a}}=n.auth.getUser(),r=s.sender_id===(a==null?void 0:a.id);return e.jsx("div",{className:`flex ${r?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${r?"bg-blue-600 text-white":"bg-gray-100 text-gray-800"}`,children:[e.jsx("p",{className:"text-sm",children:s.message}),e.jsxs("div",{className:`flex items-center gap-1 mt-1 ${r?"text-blue-100":"text-gray-500"}`,children:[e.jsx(P,{className:"h-3 w-3"}),e.jsx("p",{className:"text-xs",children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),r&&s.seen&&e.jsx("span",{className:"text-xs ml-1",children:"✓✓"})]})]})},s.id)}),e.jsx("div",{ref:v})]})}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(B,{value:m,onChange:s=>h(s.target.value),onKeyPress:$,placeholder:"Type your message...",disabled:j}),e.jsx(I,{onClick:N,disabled:j||!m.trim(),children:e.jsx(R,{className:"h-4 w-4"})})]})})]}):e.jsx(f,{className:"h-[600px] flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(b,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{children:"Select a conversation to view messages"})]})})})]})]})}export{z as default};
